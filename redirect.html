<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secure Payment Gateway</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="redirect.css" />
  </head>
  <body>

    <header>
      <div class="header-container">
        <div class="logo">
          <div class="logo-icon"><i class="fas fa-coins"></i></div>
          <div class="logo-text"><a href="index.html">HyperCoin</a></div>
        </div>

        <nav class="desktop-nav">
          <a href="index.html">Home</a>
          <a href="about.html">About</a>
          <a href="features.html">Pricing</a>
          <a href="login.html">Login</a>
        </nav>

        <div class="auth-buttons">
          <a href="login.html" class="btn btn-outline">Login</a>
          <a href="signup.html" class="btn btn-primary">Sign Up</a>
        </div>
    </header>

    <div class="container">
      <div class="headerr">
        <i class="fas fa-lock header-icon"></i>
        <h1>Secure Payment</h1>
        <p>
          Enter your payment details to complete the transaction <br />
          <b style="color: yellow"
            >MAKE SURE USERNAME IS THE EXACT USERNAME REGISTERED FOR YOUR
            ACCOUNT
          </b>
          <br />
          <a style="color: yellow" href="login.html">Login </a>
          Your Account if not sure of username
        </p>
      </div>

      <form id="payment-form" class="payment-form">
        <div class="form-group">
          <label for="item-name"
            ><i class="fa-solid fa-user"></i> Username</label
          >
          <div class="input-with-icon">
            <i class="fa-solid fa-user input-icon"></i>
            <input
              type="text"
              id="item-name"
              placeholder="Enter  username"
              required
            />
          </div>
        </div>

        <div class="form-group">
          <label for="amount"><i class="fas fa-dollar-sign"></i> Amount</label>
          <div class="input-with-icon">
            <i class="fas fa-money-bill-wave input-icon"></i>
            <input
              type="number"
              id="amount"
              placeholder="0.00"
              step="0.01"
              required
            />
          </div>
        </div>

        <p style="color: yellowgreen">
          <i style="color: red; margin-right: 15px" class="fa-solid fa-info"></i
          >Pay with stripe's checkout form instead of apple pay
        </p>

        <button type="submit" id="submit-button">
          <span>Pay Now</span>
          <div class="loader" id="loader"></div>
        </button>

        <div class="security-note">
          <i class="fas fa-shield-alt"></i>
          <span
            >Your payment is secured with Stripe's encrypted technology</span
          >
        </div>

        <div class="payment-methods">
          <i class="fab fa-cc-visa"></i>
          <i class="fab fa-cc-mastercard"></i>
          <i class="fab fa-cc-amex"></i>
          <i class="fab fa-cc-apple-pay"></i>
        </div>
      </form>

      <div class="footer">
        <p>
          © 2023 SecurePay. All rights reserved.
          <a href="#" style="color: #4f46e5; text-decoration: none"
            >Privacy Policy</a
          >
        </p>
      </div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
      const stripe = Stripe("pk_live_51Rpsq2LRwcoOq8wgsLstZO5LcuIqjk7M54Kisklu5AbUHZfeC1r1RDaEA6bz7iq6eDxFiR7yqLGrx80PsGYmdqGt007D5oIJL3");
      const form = document.getElementById("payment-form");
      const submitButton = document.getElementById("submit-button");
      const loader = document.getElementById("loader");
    
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
    
        // Show loading state
        submitButton.disabled = true;
        loader.style.display = "block";
        submitButton.querySelector("span").textContent = "Processing...";
    
        const name = document.getElementById("item-name").value.trim();
        const amount = parseFloat(document.getElementById("amount").value);
    
        if (!name || isNaN(amount)) {
          alert("Please enter a valid name and amount.");
          resetButton();
          return;
        }
    
        const cartItems = [
          {
            name,
            price: amount,
            quantity: 1,
            image: "https://res.cloudinary.com/dazhskqcc/image/upload/v1756665264/ChatGPT_Image_Aug_29_2025_12_02_56_PM_bmaix8.png",
          },
        ];
    
        try {
          // 1️⃣ Create Stripe Checkout Session
          const res = await fetch("https://backendroutes-lcpt.onrender.com/create-checkout-session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cartItems }),
          });
    
          if (!res.ok) {
            throw new Error(`Server returned ${res.status}`);
          }
    
          const data = await res.json();
    
          if (!data.id) {
            alert("Failed to create checkout session");
            resetButton();
            return;
          }
    
          // 2️⃣ Attempt secure backend notification (optional)
          const token = sessionStorage.getItem("refreshToken");
          if (token) {
            try {
              const response = await fetch("https://backendroutes-lcpt.onrender.com/transaction", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ token, balance: amount })
              });
    
              if (!response.ok) {
                console.warn("Transaction API failed with status:", response.status);
              } else {
                const result = await response.json();
                console.log("✅ Transaction API Response:", result);
              }
            } catch (secureErr) {
              console.error("Secure fetch failed:", secureErr);
            }
          } else {
            console.warn("⚠️ No token found, skipping transaction API call.");
          }
    
          // 3️⃣ Redirect to Stripe Checkout
          await stripe.redirectToCheckout({ sessionId: data.id });
    
        } catch (err) {
          console.error("Error:", err);
          alert("Server error. Check console for details.");
          resetButton();
        }
      });
    
      function resetButton() {
        submitButton.disabled = false;
        loader.style.display = "none";
        submitButton.querySelector("span").textContent = "Pay Now";
      }
    </script>
    

  </body>
</html>
